--Story: S000002 | 2.0 | [DB PREP] CUSTOMER UPDATE SCRIPT
--Description: Add the new column CUST_ID at the FLYWAYUSER.ORDERS table.
--Author: e000001 Elsao Boladao
--Date: 2019-04-03


ALTER SESSION SET DDL_LOCK_TIMEOUT = 60;

DECLARE
  COUNT_TABLE_ORDERS PLS_INTEGER;
  COUNT_ORDER_ID_PK PLS_INTEGER;

  V_TABLE_NAME VARCHAR2(30) := 'ORDERS';
  V_SCHEMA_NAME VARCHAR2(30) := 'FLYWAYUSER';

  BEGIN

      SELECT COUNT(*) INTO COUNT_TABLE_ORDERS FROM ALL_TABLES WHERE TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

      IF (COUNT_TABLE_ORDERS > 0) THEN

        SELECT COUNT(*) INTO COUNT_ORDER_ID_PK FROM ALL_TAB_COLUMNS WHERE COLUMN_NAME = 'order_constr_pk '
        AND TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

        IF(COUNT_ORDER_ID_PK = 0) THEN
          BEGIN
              EXECUTE IMMEDIATE 'ALTER TABLE ' || V_SCHEMA_NAME || '.' || V_TABLE_NAME ||  ' ADD CONSTRAINT order_constr_pk PRIMARY KEY (ORDER_ID)';

              EXCEPTION WHEN OTHERS THEN
              IF SQLCODE != -1430
				        THEN RAISE;
			        END IF;
          END;

        END IF;


      END IF;



  END;


/


