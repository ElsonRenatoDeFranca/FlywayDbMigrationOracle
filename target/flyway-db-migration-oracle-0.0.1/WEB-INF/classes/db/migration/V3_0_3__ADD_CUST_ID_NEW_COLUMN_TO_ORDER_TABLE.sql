--Story: S000002 | 2.0 | [DB PREP] CUSTOMER UPDATE SCRIPT
--Description: Add the new column CUST_ID at the FLYWAYUSER.ORDERS table.
--Author: e000001 Elsao Boladao
--Date: 2019-04-03


ALTER SESSION SET DDL_LOCK_TIMEOUT = 60;

DECLARE
  COUNT_TABLE_ORDERS PLS_INTEGER;
  COUNT_CUST_ID PLS_INTEGER;
  COUNT_COMMENT_CUST_ID PLS_INTEGER;

  V_TABLE_NAME VARCHAR2(30) := 'ORDERS';
  V_SCHEMA_NAME VARCHAR2(30) := 'FLYWAYUSER';
  V_CUST_ID VARCHAR2(30) := 'CUST_ID';

  BEGIN

      SELECT COUNT(*) INTO COUNT_TABLE_ORDERS FROM ALL_TABLES WHERE TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

      IF (COUNT_TABLE_ORDERS > 0) THEN

        SELECT COUNT(*) INTO COUNT_CUST_ID FROM ALL_TAB_COLUMNS WHERE COLUMN_NAME = V_CUST_ID
        AND TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

        IF(COUNT_CUST_ID = 0) THEN
          BEGIN
              EXECUTE IMMEDIATE 'ALTER TABLE ' || V_SCHEMA_NAME || '.' || V_TABLE_NAME ||  ' ADD ' || V_CUST_ID || ' NUMBER (10,0) NOT NULL';

              EXCEPTION WHEN OTHERS THEN
              IF SQLCODE != -1430
				        THEN RAISE;
			        END IF;
          END;

        END IF;

        SELECT COUNT(*) INTO COUNT_COMMENT_CUST_ID FROM ALL_COL_COMMENTS WHERE COLUMN_NAME = V_CUST_ID
        AND TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

        IF(COUNT_COMMENT_CUST_ID = 0) THEN
          BEGIN
              EXECUTE IMMEDIATE 'COMMENT ON COLUMN ORDERS.CUST_ID IS ''CUST id description'';';

              EXCEPTION WHEN OTHERS THEN
                IF SQLCODE != -32594
				            THEN RAISE;
			          END IF;
          END;

        END IF;
      END IF;



  END;


/


