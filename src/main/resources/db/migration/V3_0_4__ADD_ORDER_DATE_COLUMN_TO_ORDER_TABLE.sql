--Story: S000003 | 2.0 | [DB PREP] ORDER UPDATE SCRIPT
--Description: Add the new column ORDER_DATE at the FLYWAYUSER.ORDERS table.
--Author: e000001 Elsao Boladao
--Date: 2019-04-08


ALTER SESSION SET DDL_LOCK_TIMEOUT = 60;

DECLARE
  COUNT_TABLE_ORDERS PLS_INTEGER;
  COUNT_ORDER_DATE PLS_INTEGER;
  COUNT_COMMENT_ORDER_DATE PLS_INTEGER;

  V_TABLE_NAME VARCHAR2(30) := 'ORDERS';
  V_SCHEMA_NAME VARCHAR2(30) := 'FLYWAYUSER';
  V_ORDER_DATE VARCHAR2(30) := 'ORDER_DATE';

  BEGIN

      SELECT COUNT(*) INTO COUNT_TABLE_ORDERS FROM ALL_TABLES WHERE TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

      IF (COUNT_TABLE_ORDERS > 0) THEN

        SELECT COUNT(*) INTO COUNT_ORDER_DATE FROM ALL_TAB_COLUMNS WHERE COLUMN_NAME = V_ORDER_DATE
        AND TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

        IF(COUNT_ORDER_DATE = 0) THEN
          BEGIN
              EXECUTE IMMEDIATE 'ALTER TABLE ' || V_SCHEMA_NAME || '.' || V_TABLE_NAME ||  ' ADD ' || V_ORDER_DATE || ' DATE NOT NULL';

              EXCEPTION WHEN OTHERS THEN
              IF SQLCODE != -1430
				        THEN RAISE;
			        END IF;
          END;

        END IF;

        SELECT COUNT(*) INTO COUNT_COMMENT_ORDER_DATE FROM ALL_COL_COMMENTS WHERE COLUMN_NAME = V_ORDER_DATE
        AND TABLE_NAME = V_TABLE_NAME AND OWNER = V_SCHEMA_NAME;

        IF(COUNT_COMMENT_ORDER_DATE = 0) THEN
          BEGIN
              EXECUTE IMMEDIATE 'COMMENT ON COLUMN ORDERS.ORDER_DATE IS ''ORDER_DATE description'';';

              EXCEPTION WHEN OTHERS THEN
                IF SQLCODE != -32594
				            THEN RAISE;
			          END IF;
          END;

        END IF;
      END IF;

  END;


/


